<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiMi AI Assistant - N·∫°p Firmware Tr·ª±c Tuy·∫øn</title>
    <style>
        /* Thi·∫øt l·∫≠p c∆° b·∫£n */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; line-height: 1.6; color: #333; }
        h1, h2 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 25px; }
        h1 { font-size: 2.5em; text-align: center; color: #4CAF50; border-bottom: none; }
        .header-section { text-align: center; margin-bottom: 40px; }
        .header-section p { font-size: 1.1em; color: #555; }
        .cta-button { display: inline-block; padding: 12px 25px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; transition: background-color 0.3s; margin-top: 15px; }
        .cta-button:hover { background-color: #0056b3; }
        
        /* C·∫•u tr√∫c WebFlash */
        .webflash-container { background-color: #f9f9f9; padding: 30px; border-radius: 8px; border: 1px solid #ddd; margin-top: 30px; }
        .webflash-container h2 { color: #dc3545; border-bottom: 1px dashed #ccc; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        select, input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        esp-web-install-button { display: block; margin-top: 30px; }
        .rom-description { margin-top: 10px; color: #444; font-size: 0.95em; min-height: 1.2em; }

        /* N√∫t t√πy ch·ªânh */
        #install-button button { background-color: #4CAF50; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 1.1em; cursor: pointer; transition: background-color 0.3s; }
        #install-button button:hover { background-color: #45a049; }
        
        /* Danh s√°ch t√≠nh nƒÉng */
        .features-list { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .features-list li { background: #e9ecef; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .features-list li strong { color: #007bff; display: block; margin-bottom: 5px; }

    </style>
    <script type="module" src="https://unpkg.com/esp-web-tools@9.0.2/dist/web/install-button.js"></script>
</head>
<body>

    <header class="header-section">
        <h1 style="color: #4CAF50;">ü§ñ MiMi AI Assistant</h1>
        <p>MiMi l√† m·ªôt **tr·ª£ l√Ω AI m√£ ngu·ªìn m·ªü** ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ t·ª± ƒë·ªông h√≥a c√°c t√°c v·ª• ph·ª©c t·∫°p, ƒë·∫∑c bi·ªát trong lƒ©nh v·ª±c giao d·ªãch v√† ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã th√¥ng minh (IoT) d·ª±a tr√™n ESP32/ESP8266.</p>
        <a href="https://github.com/iZFxTrade/Mimi" target="_blank" class="cta-button">Xem M√£ Ngu·ªìn tr√™n GitHub</a>
    </header>

    <hr>

    <section>
        <h2>‚ú® T√≠nh NƒÉng N·ªïi B·∫≠t (T·ª´ README)</h2>
        <ul class="features-list">
            <li><strong>Giao d·ªãch T·ª± ƒë·ªông:</strong> T√≠ch h·ª£p c√°c thu·∫≠t to√°n giao d·ªãch ti√™n ti·∫øn v√† qu·∫£n l√Ω r·ªßi ro.</li>
            <li><strong>ƒêi·ªÅu khi·ªÉn Thi·∫øt b·ªã IoT:</strong> T∆∞∆°ng t√°c v√† qu·∫£n l√Ω c√°c board m·∫°ch ESP32/ESP8266.</li>
            <li><strong>C·ªông ƒë·ªìng & M·ªü r·ªông:</strong> Thi·∫øt k·∫ø m√£ ngu·ªìn m·ªü, d·ªÖ d√†ng t√πy ch·ªânh v√† t√≠ch h·ª£p c√°c c√¥ng c·ª• b√™n ngo√†i (qua MCP).</li>
        </ul>
    </section>

    <hr>

    <div class="webflash-container">
        <h2>‚ö° MiMi WebFlash - C√¥ng c·ª• N·∫°p Firmware Tr·ª±c Tuy·∫øn</h2>
        <p>S·ª≠ d·ª•ng c√¥ng c·ª• n√†y ƒë·ªÉ n·∫°p firmware cho board m·∫°ch MiMi c·ªßa b·∫°n tr·ª±c ti·∫øp t·ª´ tr√¨nh duy·ªát web. **Kh√¥ng c·∫ßn c√†i ƒë·∫∑t ph·∫ßn m·ªÅm b√™n ngo√†i!**</p>
        
        <div id="rom-selection">
            <label for="rom-select">1. Ch·ªçn Phi√™n b·∫£n Firmware MiMi:</label>
            <select id="rom-select">
                <option value="" disabled selected>-- Ch·ªçn lo·∫°i board/firmware --</option>
            </select>
            <p id="rom-description" class="rom-description"></p>

            <label for="firmware-url" style="margin-top: 20px;">HO·∫∂C 2. D√°n URL Manifest T√πy Ch·ªânh:</label>
            <input type="text" id="firmware-url" placeholder="D√°n URL Manifest (.json) t·ª´ ngu·ªìn kh√°c (V√≠ d·ª•: https://example.com/custom.json)">
        </div>

        <esp-web-install-button id="install-button" manifest="">
            <button slot="activate">Ch·ªçn C·ªïng USB & N·∫°p Firmware</button>
            <span slot="unsupported">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£. Vui l√≤ng d√πng Chrome/Edge.</span>
            <span slot="progress">ƒêang k·∫øt n·ªëi v√† n·∫°p firmware...</span>
            <span slot="installed">‚úÖ ƒê√£ n·∫°p th√†nh c√¥ng!</span>
        </esp-web-install-button>

        <p style="margin-top: 30px; font-size: 0.9em; color: #666;">* L∆∞u √Ω quan tr·ªçng: Vui l√≤ng ch·ªçn Firmware ·ªü b∆∞·ªõc 1 ho·∫∑c d√°n URL Manifest ·ªü b∆∞·ªõc 2.</p>
    </div>

    <hr>

    <footer>
        <p style="text-align: center; font-size: 0.9em; margin-top: 20px;">&copy; 2025 iZFxTrade - D·ª± √°n MiMi. | Powered by ESP Web Tools.</p>
    </footer>

    <script>
        const installButton = document.getElementById('install-button');
        const firmwareUrlInput = document.getElementById('firmware-url');
        const romSelect = document.getElementById('rom-select');
        const romDescription = document.getElementById('rom-description');

        let firmwareList = [];
        let defaultManifestUrl = '';
        const firmwareMeta = new Map();

        async function populateFirmwareList() {
            romSelect.innerHTML = '<option value="" disabled selected>-- Ch·ªçn lo·∫°i board/firmware --</option>';
            firmwareMeta.clear();

            try {
                const response = await fetch('./webflasher/roms.json', { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                firmwareList = Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch firmware:', error);
                firmwareList = [];
                installButton.manifest = '';
                defaultManifestUrl = '';
                if (romDescription) {
                    romDescription.textContent = 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ROM. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh.';
                }
                return;
            }

            if (firmwareList.length === 0) {
                installButton.manifest = '';
                defaultManifestUrl = '';
                if (romDescription) {
                    romDescription.textContent = 'Ch∆∞a c√≥ ROM n√†o ƒë∆∞·ª£c c√¥ng b·ªë.';
                }
                return;
            }

            defaultManifestUrl = firmwareList[0].manifest || '';
            if (defaultManifestUrl) {
                installButton.manifest = defaultManifestUrl;
            }

            firmwareList.forEach(item => {
                firmwareMeta.set(item.manifest, item);
                const option = document.createElement('option');
                option.value = item.manifest;
                option.textContent = `${item.board} - v${item.version}`;
                romSelect.appendChild(option);
            });

            if (romDescription && defaultManifestUrl) {
                const meta = firmwareMeta.get(defaultManifestUrl);
                romDescription.textContent = meta?.description || '';
            }
        }

        function setDescription(manifestUrl, isCustom = false) {
            if (!romDescription) {
                return;
            }
            if (isCustom) {
                romDescription.textContent = manifestUrl ? 'ƒêang s·ª≠ d·ª•ng manifest t√πy ch·ªânh.' : '';
                return;
            }
            const meta = firmwareMeta.get(manifestUrl);
            romDescription.textContent = meta?.description || '';
        }

        function updateManifest() {
            const customUrl = firmwareUrlInput.value.trim();
            const selectedRomUrl = romSelect.value;

            if (customUrl && customUrl.endsWith('.json')) {
                installButton.manifest = customUrl;
                romSelect.value = '';
                setDescription(customUrl, true);
            } else if (selectedRomUrl) {
                installButton.manifest = selectedRomUrl;
                firmwareUrlInput.value = '';
                setDescription(selectedRomUrl);
            } else if (defaultManifestUrl) {
                installButton.manifest = defaultManifestUrl;
                setDescription(defaultManifestUrl);
            } else {
                installButton.manifest = '';
                setDescription('');
            }

            console.log('Manifest URL updated to:', installButton.manifest);
        }

        firmwareUrlInput.addEventListener('input', updateManifest);
        romSelect.addEventListener('change', updateManifest);

        populateFirmwareList().then(() => {
            updateManifest();
        });
    </script>
</body>
</html>
