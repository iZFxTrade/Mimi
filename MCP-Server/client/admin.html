<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP-Server Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body, html { height: 100%; overflow: hidden; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 260px; flex-shrink: 0; background-color: #343a40; color: white; height: 100vh; transition: width 0.3s; }
        .main-content { flex-grow: 1; padding: 25px; overflow-y: auto; height: 100vh; }
        .chat-container { width: 450px; flex-shrink: 0; border-left: 1px solid #dee2e6; height: 100vh; display: flex; flex-direction: column; transition: width 0.3s; }
        
        /* Collapsed state for chat */
        .chat-container.collapsed { width: 0; border-left: none; }
        .chat-container.collapsed > * { display: none; }

        .nav-link { color: #adb5bd; }
        .nav-link:hover, .nav-link.active { color: white; background-color: #495057; }
        .view { display: none; }
        .view.active { display: block; }

        .chat-header { padding: 0.75rem 1rem; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; justify-content: space-between; }
        .chat-body { flex-grow: 1; padding: 1rem; overflow-y: auto; background-color: #f8f9fa; }
        .chat-footer { padding: 1rem; border-top: 1px solid #dee2e6; background-color: #fff; }
    </style>
</head>
<body>
    <div id="app-toggle-button" style="position: fixed; top: 15px; right: 15px; z-index: 2000; cursor: pointer; background: #6c757d; color: white; border-radius: 5px; padding: 2px 8px;">
        <i class="bi bi-layout-sidebar-inset"></i>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column p-3">
             <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none"><i class="bi bi-cpu-fill me-2"></i><span class="fs-4">MCP-Server</span></a><hr><ul class="nav nav-pills flex-column mb-auto"><li class="nav-item"><a href="#dashboard" class="nav-link active" data-view="dashboard-view"><i class="bi bi-grid-fill me-2"></i>Dashboard</a></li><li><a href="#users" class="nav-link" data-view="users-view"><i class="bi bi-people-fill me-2"></i>Users</a></li><li><a href="#assistants" class="nav-link" data-view="assistants-view"><i class="bi bi-robot me-2"></i>Assistants</a></li><li><a href="#smart-home" class="nav-link" data-view="smart-home-view"><i class="bi bi-house-heart-fill me-2"></i>Smart Home</a></li><li><a href="#capabilities" class="nav-link" data-view="capabilities-view"><i class="bi bi-lightning-charge-fill me-2"></i>AI Capabilities</a></li></ul><hr><div class="dropdown"><a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown"><img src="https://github.com/mdo.png" alt="" width="32" height="32" class="rounded-circle me-2"><strong id="current-username">Admin</strong></a><ul class="dropdown-menu dropdown-menu-dark text-small shadow"><li><a class="dropdown-item" href="#" id="logout-btn">Sign out</a></li></ul></div>
        </div>

        <!-- Main Content -->
        <main class="main-content"></main>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-header">
                <span class="h5 mb-0" id="chat-assistant-name">No Assistant</span>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="bi bi-robot"></i></button>
                    <ul class="dropdown-menu dropdown-menu-end" id="chat-assistant-selector"></ul>
                </div>
            </div>
            <div class="chat-body" id="chat-body"><p class="text-center text-muted mt-3">Select an assistant to begin.</p></div>
            <div class="chat-footer"><div class="input-group"><input type="text" class="form-control" placeholder="Chat is disabled" id="chat-input" disabled><button class="btn btn-primary" type="button" id="chat-send-btn" disabled><i class="bi bi-send-fill"></i></button></div></div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div class="modal fade" id="user-modal">...</div> <!-- Modal content remains the same -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const state = { token: localStorage.getItem('mcp_token'), db: {}, modals: {}, currentAssistantId: null };
    const API_BASE_URL = 'http://127.0.0.1:8000';

    // API & DATA FETCHING (apiRequest, login, fetchAllData - no changes)
    async function apiRequest(endpoint, method = 'GET', body = null) { const options = { method, headers: { 'Authorization': `Bearer ${state.token}` } }; if (body) { options.headers['Content-Type'] = 'application/json'; options.body = JSON.stringify(body); } const response = await fetch(`${API_BASE_URL}${endpoint}`, options); if (!response.ok) { const error = await response.json().catch(() => ({ detail: response.statusText })); console.error(`API Error on ${method} ${endpoint}:`, error); if (response.status === 401) { alert('Session expired. Please reload.'); localStorage.removeItem('mcp_token'); } throw new Error(error.detail); } return response.status === 204 ? null : response.json(); }
    async function login() { const params = new URLSearchParams({ username: 'admin', password: 'admin' }); try { const response = await fetch(`${API_BASE_URL}/api/auth/token`, { method: 'POST', body: params }); if (!response.ok) throw new Error('Login failed'); const data = await response.json(); state.token = data.access_token; localStorage.setItem('mcp_token', state.token); return true; } catch (error) { console.error(error); alert("Automatic login failed. Is server running with CORS enabled?"); return false; } }
    async function fetchAllData() { const dataTypes = ['users', 'assistants', 'homes', 'rooms', 'devices', 'scenes', 'models', 'tools', 'actions']; const promises = dataTypes.map(type => apiRequest(`/api/${type}/`)); try { const results = await Promise.all(promises); dataTypes.forEach((type, index) => { state.db[type] = results[index]; }); console.log("Data fetch complete."); } catch (error) { console.error("Could not fetch all data:", error.message); } }

    // RENDER LOGIC
    const hasRealData = (c) => state.db[c]?.some(i => !i.is_mock);
    const getData = (c) => state.db[c] ? (hasRealData(c) ? state.db[c].filter(i => !i.is_mock) : state.db[c]) : [];
    const findById = (c, id) => state.db[c]?.find(i => i.id === id);
    const renderLabel = (isMock) => isMock ? `<span class="badge bg-light text-dark ms-2">Demo</span>` : '';

    function renderAllViews() {
        const views = {
            'dashboard-view': renderDashboard,
            'users-view': renderUsers,
            'assistants-view': renderAssistants,
            'smart-home-view': renderSmartHome,
            'capabilities-view': renderCapabilities
        };
        let content = '';
        for (const [id, func] of Object.entries(views)) {
            content += `<div class="view" id="${id}">${func()}</div>`;
        }
        document.querySelector('.main-content').innerHTML = content;
        document.querySelector('.view').classList.add('active'); // Activate first view
        
        // Re-attach listeners after re-rendering content
        attachCRUDListeners();
    }

    // FULL RENDER FUNCTIONS FOR ALL VIEWS
    const renderDashboard = () => `<h1>Dashboard</h1><p>Welcome! Data is loaded, including demo data. You can test assistants in the chat panel.</p>`;
    const renderUsers = () => { const users = getData('users'); return `<div class="d-flex justify-content-between align-items-center mb-3"><h1>User Management</h1><button class="btn btn-primary crud-action" data-action="addUser"><i class="bi bi-plus-circle-fill me-2"></i>Add User</button></div><table class="table table-hover"><thead><tr><th>ID</th><th>Username</th><th>Role</th><th>Actions</th></tr></thead><tbody>` + users.map(u => `<tr><td>${u.id}</td><td>${u.username} ${renderLabel(u.is_mock)}</td><td><span class="badge bg-primary">${u.role}</span></td><td><button class="btn btn-sm btn-outline-secondary crud-action" data-action="editUser" data-id="${u.id}">Edit</button> <button class="btn btn-sm btn-outline-danger crud-action" data-action="deleteUser" data-id="${u.id}">Delete</button></td></tr>`).join('') + `</tbody></table>`; };
    const renderAssistants = () => { const assistants = getData('assistants'); return `<div class="d-flex justify-content-between align-items-center mb-3"><h1>Assistants</h1><button class="btn btn-primary"><i class="bi bi-plus-circle-fill me-2"></i>Add Assistant</button></div><div class="list-group">` + assistants.map(a => `<div class="list-group-item"><strong>${a.name}</strong> ${renderLabel(a.is_mock)} <small class="text-muted">| Owner: ${findById('users', a.owner_id)?.username || 'N/A'}</small></div>`).join('') + `</div>`; };
    const renderSmartHome = () => { const homes = getData('homes'); const rooms = getData('rooms'); const devices = getData('devices'); return `<h1>Smart Home Structure</h1><div class="accordion">` + homes.map(h => `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#h-${h.id}">${h.name} ${renderLabel(h.is_mock)}</button></h2><div id="h-${h.id}" class="accordion-collapse collapse"><div class="accordion-body">` + rooms.filter(r => r.home_id === h.id).map(r => `<h6>${r.name}</h6><ul>` + devices.filter(d => d.room_id === r.id).map(d => `<li>${d.name} <span class="badge bg-secondary">${d.status}</span></li>`).join('') + `</ul>`).join('') + `</div></div></div>`).join('') + `</div>`; };
    const renderCapabilities = () => { const models = getData('models'); const tools = getData('tools'); return `<h1>AI Capabilities</h1><h5>AI Models</h5><div class="list-group mb-3">` + models.map(m => `<div class="list-group-item">${m.name} ${renderLabel(m.is_mock)} <span class="badge bg-dark">${m.provider}</span></div>`).join('') + `</div><h5>Internal Tools</h5><div class="list-group">` + tools.map(t => `<div class="list-group-item"><strong>${t.name}</strong> ${renderLabel(t.is_mock)}<p class="mb-0 text-muted small">${t.description}</p></div>`).join('') + `</div>`; };

    // CHAT & CRUD
    function populateAssistantSelector() { const selector = document.getElementById('chat-assistant-selector'); const assistants = getData('assistants'); selector.innerHTML = assistants.map(a => `<li><a class="dropdown-item" href="#" data-id="${a.id}">${a.name}</a></li>`).join(''); selector.querySelectorAll('a').forEach(a => a.addEventListener('click', e => selectAssistant(e.currentTarget.dataset.id)));}
    function selectAssistant(id) { state.currentAssistantId = id; const assistant = findById('assistants', parseInt(id)); document.getElementById('chat-assistant-name').textContent = assistant ? assistant.name : "No Assistant"; document.getElementById('chat-input').disabled = !assistant; document.getElementById('chat-send-btn').disabled = !assistant; document.getElementById('chat-input').placeholder = assistant ? `Message ${assistant.name}...` : 'Chat is disabled'; }
    function attachCRUDListeners() { document.querySelector('.main-content').addEventListener('click', e => { const target = e.target.closest('.crud-action'); if (!target) return; const { action, id } = target.dataset; if (action === 'addUser') handleAddUser(); if (action === 'editUser') handleEditUser(id); if (action === 'deleteUser') handleDeleteUser(id); }); }
    function handleAddUser() { /* Modal logic same as before */ }
    function handleEditUser(id) { /* Modal logic same as before */ }
    async function handleDeleteUser(id) { /* API call logic same as before */ }
    async function handleUserFormSubmit(event) { /* API call logic same as before */ }

    // APP INITIALIZATION
    document.addEventListener('DOMContentLoaded', async () => {
        // Navigation
        document.querySelector('.sidebar').addEventListener('click', e => { if (e.target.matches('.nav-link')) { e.preventDefault(); const viewId = e.target.getAttribute('data-view'); document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); document.querySelectorAll('.sidebar .nav-link').forEach(n => n.classList.remove('active')); e.target.classList.add('active'); } });
        document.getElementById('app-toggle-button').addEventListener('click', () => document.querySelector('.chat-container').classList.toggle('collapsed'));
        
        // Init & Load
        if (!(await login())) return;
        await fetchAllData();
        renderAllViews();
        populateAssistantSelector();
        selectAssistant(getData('assistants')[0]?.id); // Select first assistant by default
    });
    </script>
</body>
</html>