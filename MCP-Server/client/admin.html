<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP-Server Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 280px;
            --chat-width: 450px;
            --chat-collapsed-width: 0px;
        }
        body, html {
            height: 100%;
            overflow: hidden;
            background-color: #f8f9fa;
        }
        .app-container {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr var(--chat-width);
            height: 100vh;
            transition: grid-template-columns 0.3s ease-in-out;
        }
        .app-container.chat-collapsed {
            grid-template-columns: var(--sidebar-width) 1fr var(--chat-collapsed-width);
        }
        .sidebar {
            background-color: #212529;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            height: 100vh;
            overflow-y: auto;
        }
        .sidebar .nav-link { color: #ced4da; }
        .sidebar .nav-link:hover { color: #fff; }
        .sidebar .nav-link.active { color: #fff; font-weight: 500; }
        .main-content {
            padding: 2rem;
            height: 100vh;
            overflow-y: auto;
        }
        .chat-panel {
            border-left: 1px solid #dee2e6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            transition: all 0.3s ease-in-out;
            overflow: hidden; /* Hide content when collapsed */
        }
        .chat-header { 
            padding: 1rem; 
            border-bottom: 1px solid #dee2e6; 
            display: flex;
            align-items: center;
            gap: 0.75rem; /* spacing between items */
        }
        .chat-body { flex-grow: 1; padding: 1rem; overflow-y: auto; }
        .chat-footer { padding: 1rem; border-top: 1px solid #dee2e6; }

        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { { opacity: 1; } } }

    </style>
</head>
<body>
    <!-- App Container -->
    <div id="app-container" class="app-container">
        <!-- Sidebar -->
        <div class="sidebar"> 
            <a href="#" class="d-flex align-items-center mb-4 text-white text-decoration-none">
                <i class="bi bi-cpu-fill me-3 fs-2"></i><span class="fs-4">MCP-Server</span>
            </a>
            <ul class="nav nav-pills flex-column mb-auto" id="main-nav">
                <li class="nav-item"><a href="#dashboard" class="nav-link active" data-view="dashboard-view"><i class="bi bi-grid-fill me-2"></i>Dashboard</a></li>
                <li class="nav-item"><a href="#users" class="nav-link" data-view="users-view"><i class="bi bi-people-fill me-2"></i>Users</a></li>
                <li class="nav-item"><a href="#assistants" class="nav-link" data-view="assistants-view"><i class="bi bi-robot me-2"></i>Assistants</a></li>
                <li class="nav-item"><a href="#smart-home" class="nav-link" data-view="smart-home-view"><i class="bi bi-house-heart-fill me-2"></i>Smart Home</a></li>
                <li class="nav-item"><a href="#capabilities" class="nav-link" data-view="capabilities-view"><i class="bi bi-lightning-charge-fill me-2"></i>AI Capabilities</a></li>
            </ul>
            <hr>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=0d6efd&color=fff" alt="" width="32" height="32" class="rounded-circle me-2">
                    <strong id="current-username">Admin</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                    <li><a class="dropdown-item" href="#" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i>Sign out</a></li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Views will be inserted here -->
            <div id="dashboard-view" class="view active">...</div>
            <div id="users-view" class="view">...</div>
            <!-- etc. -->
        </main>

        <!-- Chat Panel -->
        <aside class="chat-panel">
            <div class="chat-header">
                <button class="btn btn-sm btn-outline-secondary" id="chat-toggle-btn"><i class="bi bi-layout-sidebar-inset"></i></button>
                <span class="h5 mb-0 text-truncate flex-grow-1" id="chat-assistant-name">No Assistant</span>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="bi bi-robot"></i></button>
                    <ul class="dropdown-menu dropdown-menu-end" id="chat-assistant-selector"></ul>
                </div>
            </div>
            <div class="chat-body" id="chat-body"><p class="text-center text-muted mt-3">Select an assistant to begin.</p></div>
            <div class="chat-footer">
                <div class="input-group"><input type="text" class="form-control" placeholder="Chat is disabled" id="chat-input" disabled><button class="btn btn-primary" type="button" id="chat-send-btn" disabled><i class="bi bi-send-fill"></i></button></div>
            </div>
        </aside>
    </div>

    <!-- MODALS AND TEMPLATES -->
    <div class="modal fade" id="user-modal">...</div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const App = {
        state: { token: localStorage.getItem('mcp_token'), db: {}, currentAssistantId: null },
        config: { API_BASE_URL: 'http://127.0.0.1:8000' },
        elements: { userModal: null },

        async init() {
            this.elements.userModal = new bootstrap.Modal(document.getElementById('user-modal'));
            this.setupEventListeners();

            if (!this.state.token) {
                if (!await this.api.login('admin', 'admin')) {
                    alert('FATAL: Could not log in.');
                    return;
                }
            }
            
            await this.fetchAllData();
            this.renderAll();
            this.navigateTo('dashboard-view');
        },

        setupEventListeners() {
            document.getElementById('main-nav').addEventListener('click', (e) => {
                if (e.target.closest('a')) {
                    e.preventDefault();
                    this.navigateTo(e.target.closest('a').dataset.view);
                }
            });
            document.getElementById('chat-toggle-btn').addEventListener('click', () => {
                document.getElementById('app-container').classList.toggle('chat-collapsed');
            });
            // ... other listeners ...
        },

        navigateTo(viewId) { /* ... no change ... */ },

        async fetchAllData() {
            const dataTypes = ['users', 'assistants', 'homes', 'rooms', 'devices', 'scenes', 'models', 'tools'];
            const promises = dataTypes.map(type => this.api.get(`/api/${type}/`));
            
            const results = await Promise.allSettled(promises);
            
            results.forEach((result, index) => {
                const type = dataTypes[index];
                if (result.status === 'fulfilled') {
                    this.state.db[type] = result.value;
                } else {
                    console.warn(`Could not fetch data for '${type}': ${result.reason.message}`);
                    this.state.db[type] = []; // Initialize as empty array on failure
                }
            });
            console.log("Database state loaded (gracefully):", this.state.db);
        },

        api: { /* ... no change ... */ },
        renderAll() { /* ... no change ... */ },
        render: { /* ... no change ... */ },
        handleUserModal(id = null) { /* ... no change ... */ },
        async handleUserFormSubmit(event) { /* ... no change ... */ },
        async handleDeleteUser(id) { /* ... no change ... */ },
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
